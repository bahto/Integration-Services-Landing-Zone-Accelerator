{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"serviceBus": {
			"type": "object",
			"defaultValue": {
            "name": "SampleNameServicebusInstance"
        }
		},		
		"vNet": {
            "type": "object"
        },
        "platform": {
            "type": "object"
        }
		
	},
	 "variables": {
        "pepName": "[concat('pep-',parameters('platform').systemPrefix,'-sbus-',parameters('platform').environment)]",
        "pepNicName": "[concat('nic-',parameters('platform').systemPrefix,'-sbus-',parameters('platform').environment)]",

		// Sample Queues & topics & subscriptions
		"queues": {
            "type": "array",
            "defaultValue": [
                {
                    "name": "SampleQ1",
                    "lockDuration": "PT5M"
                },
                "SampleQ2"
            ]
        },
		"topics": {
            "type": "array",
            "defaultValue": [
                "SampleT1",
                "SampleT2"
            ]
        },
		"subscriptions": {
            "type": "array",
            "defaultValue": [
                {
                    "topic": "SampleT1",
                    "subscription": "SampleAppTopic1Subcriber"
                },
				{
                    "topic": "SampleT2",
                    "subscription": "SampleAppTopic2Subcriber"
                }
            ]
        }

    },
	"resources": [
		{
			"type": "Microsoft.ServiceBus/namespaces",
			"apiVersion": "2021-11-01",
			"name": "[parameters('serviceBus').name]",
			"location": "[parameters('platform').region]",
			"sku": {
				"name": "[parameters('serviceBus').sku]"				
			},
			"properties": {
				"publicNetworkAccess": "Disabled",
				"disableLocalAuth": false,
				"zoneRedundant": false
			}
		},
		{
			"type": "Microsoft.ServiceBus/namespaces/AuthorizationRules",
			"apiVersion": "2021-11-01",
			"name": "[concat(parameters('serviceBus').name, '/RootManageSharedAccessKey')]",
			"location": "[parameters('platform').region]",
			"dependsOn": [
				"[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBus').name)]"
			],
			"properties": {
				"rights": [
					"Listen",
					"Manage",
					"Send"
				]
			}
		},
		{
            "location": "[parameters('platform').region]",
            "name": "[variables('pepName')]",
            "type": "Microsoft.Network/privateEndpoints",
            "apiVersion": "2022-05-01",
            "properties": {
                "subnet": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets',parameters('vnet').name, parameters('vnet').privateLink.name)]"
                },
                "customNetworkInterfaceName": "[variables('pepNicName')]",
                "privateLinkServiceConnections": [
                    {
                        "name": "[variables('pepName')]",
                        "properties": {
                            "privateLinkServiceId": "[resourceId('Microsoft.ServiceBus/namespaces',parameters('serviceBus').name)]",
                            "groupIds": [ "namespace" ]
                        }
                    }
                ]
            },
            "tags": {},
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces',parameters('serviceBus').name)]"

            ]
        },
		{
            "type": "Microsoft.ServiceBus/namespaces/queues",
            "apiVersion": "2021-11-01",
            "name": "[concat(parameters('serviceBus').name, '/', if(contains(variables('queues')[copyIndex()], 'name'), variables('queues')[copyIndex()].name, variables('queues')[copyIndex()]))]",
            "location": "[parameters('platform').region]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBus').name)]"
            ],
            "properties": {
                "lockDuration": "[if(contains(variables('queues')[copyIndex()], 'lockDuration'), variables('queues')[copyIndex()].lockDuration, 'PT3M')]",
                "maxSizeInMegabytes": 1024,
                "requiresDuplicateDetection": false,
                "requiresSession": false,
                "defaultMessageTimeToLive": "P14D",
                "deadLetteringOnMessageExpiration": true,
                "enableBatchedOperations": true,
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "maxDeliveryCount": 10,
                "status": "Active",
                "enablePartitioning": false,
                "enableExpress": false
            },
            "copy": {
                "name": "queueCopy",
                "count": "[length(variables('queues'))]"
            }
        },
		{
            "type": "Microsoft.ServiceBus/namespaces/topics",
            "apiVersion": "2021-11-01",
            "name": "[concat(parameters('serviceBus').name, '/', variables('topics')[copyIndex()])]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBus').name)]"
            ],
            "properties": {
                "defaultMessageTimeToLive": "P365D",
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "enableBatchedOperations": false,
                "enableExpress": true,
                "enablePartitioning": false,
                "maxSizeInMegabytes": 1024,
                "requiresDuplicateDetection": false,
                "status": "Active",
                "supportOrdering": true
            },
            "copy": {
                "name": "topicCopy",
                "count": "[length(variables('topics'))]"
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
            "apiVersion": "2021-11-01",
            "name": "[concat(parameters('serviceBus').name, '/', variables('subscriptions')[copyIndex()].topic, '/', variables('subscriptions')[copyIndex()].subscription)]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBus').name, variables('subscriptions')[copyIndex()].topic)]",
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBus').name)]"
            ],
            "properties": {
                "autoDeleteOnIdle": "P365D",
                "deadLetteringOnFilterEvaluationExceptions": false,
                "deadLetteringOnMessageExpiration": false,
                "defaultMessageTimeToLive": "P14D",
                "enableBatchedOperations": true,
                "lockDuration": "PT5M",
                "maxDeliveryCount": 10,
                "requiresSession": false,
                "status": "Active"
            },
            "copy": {
                "name": "subscriptionCopy",
                "count": "[length(variables('subscriptions'))]"
            }
        }
	]
}